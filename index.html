<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AR Cell Model Viewer</title>

    <!-- model-viewer web component -->
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js">
    </script>

    <style>
      :not(:defined) > * {
        display: none;
      }

      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #05070a;
        color: #f5f5f5;
      }

      model-viewer {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100dvh;
        background-color: #111;
        overflow: hidden;
      }

      #ar-button {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: calc(env(safe-area-inset-bottom) + 20px);
        z-index: 9999;

        background-color: #fff;
        padding: 0 26px;
        min-width: 220px;
        height: 48px;
        line-height: 48px;

        font-size: 16px;
        font-weight: 500;
        color: #4285f4;

        border-radius: 24px;
        border: 1px solid #dadce0;
        white-space: nowrap;
      }

      #ar-button:active {
        background-color: #e8eaed;
      }

      #ar-button:focus {
        outline: none;
      }

      #ar-button:focus-visible {
        outline: 1px solid #4285f4;
      }

      /* Hotspots */
      .hotspot {
        border: none;
        padding: 0;
        background: none;
        cursor: pointer;
        transform: translate(-50%, -50%);
      }

      .hotspot-label {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.78);
        color: #fff;
        font-size: 12px;
        line-height: 1.3;
        backdrop-filter: blur(6px);
      }

      .hotspot-label::before {
        content: "";
        width: 9px;
        height: 9px;
        border-radius: 50%;
        background: #4caf50;
        box-shadow: 0 0 6px rgba(76, 175, 80, 0.8);
      }

      .hotspot-description {
        display: none;
        margin-left: 4px;
        font-size: 11px;
        opacity: 0.9;
      }

      .hotspot:hover .hotspot-description {
        display: inline;
      }

      /* AR prompt + failure */
      @keyframes circle {
        from {
          transform: translateX(-50%) rotate(0deg) translateX(50px) rotate(0deg);
        }
        to {
          transform: translateX(-50%) rotate(360deg) translateX(50px)
            rotate(-360deg);
        }
      }

      @keyframes elongate {
        from {
          transform: translateX(100px);
        }
        to {
          transform: translateX(-100px);
        }
      }

      model-viewer > #ar-prompt {
        position: absolute;
        left: 50%;
        bottom: 175px;
        animation: elongate 2s infinite ease-in-out alternate;
        display: none;
      }

      model-viewer[ar-status="session-started"] > #ar-prompt {
        display: block;
      }

      model-viewer > #ar-prompt > img {
        animation: circle 4s linear infinite;
      }

      model-viewer > #ar-failure {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        bottom: 175px;
        display: none;
      }

      model-viewer[ar-tracking="not-tracking"] > #ar-failure {
        display: block;
      }

      /* Control panel */
      #hotspot-controls {
        position: fixed;
        right: 12px;
        top: 12px;
        width: 320px;
        max-height: calc(100dvh - 24px);
        overflow-y: auto;
        padding: 12px 14px;
        border-radius: 12px;
        background: rgba(7, 9, 15, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.06);
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.65);
        z-index: 10000;
      }

      #hotspot-controls h2 {
        font-size: 14px;
        margin: 0 0 4px;
      }

      #hotspot-controls p {
        margin: 0 0 10px;
        font-size: 11px;
        color: #aaa;
      }

      .hotspot-panel {
        border-top: 1px solid rgba(255, 255, 255, 0.06);
        padding-top: 8px;
        margin-top: 8px;
      }

      .hotspot-panel:first-of-type {
        border-top: none;
        margin-top: 0;
        padding-top: 0;
      }

      .hotspot-panel-title {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 4px;
      }

      .hotspot-panel-title span.name {
        font-size: 12px;
        font-weight: 600;
      }

      .coords {
        font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo,
          Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 10px;
        color: #bbb;
      }

      .axis-row {
        display: grid;
        grid-template-columns: 14px 1fr 40px;
        gap: 6px;
        align-items: center;
        margin-bottom: 4px;
      }

      .axis-row label {
        font-size: 11px;
        color: #ccc;
      }

      .axis-row input[type="range"] {
        width: 100%;
      }

      .axis-value {
        font-size: 11px;
        text-align: right;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }
    </style>
  </head>

  <body>
    <model-viewer
      id="cell-viewer"
      src="model.glb"
      ios-src="model.usdz"
      shadow-intensity="1"
      ar
      camera-controls
      touch-action="pan-y"
      alt="A 3D cell model with hotspots">
      <!-- AR button -->
      <button slot="ar-button" id="ar-button">View in your space</button>

      <!-- Nucleus -->
      <button
        slot="hotspot-nucleus"
        class="hotspot"
        data-position="-8.332 1.103 -1.368"
        data-normal="0.973 -0.164 0.164"
        data-visibility-attribute="visible">
        <div class="hotspot-label">
          Nucleus
          <span class="hotspot-description">
            Contains genetic material and controls cell activity.
          </span>
        </div>
      </button>

      <!-- Golgi Complex -->
      <button
        slot="hotspot-golgi"
        class="hotspot"
        data-position="5.767 5.383 3.847"
        data-normal="-0.679 -0.519 -0.519"
        data-visibility-attribute="visible">
        <div class="hotspot-label">
          Golgi Complex
          <span class="hotspot-description">
            Modifies, sorts, and packages proteins.
          </span>
        </div>
      </button>

      <!-- Mitochondrion -->
      <button
        slot="hotspot-mito"
        class="hotspot"
        data-position="7.916 3.887 0.024"
        data-normal="-0.842 -0.507 -0.181"
        data-visibility-attribute="visible">
        <div class="hotspot-label">
          Mitochondrion
          <span class="hotspot-description">
            Produces ATP, the cell's main energy source.
          </span>
        </div>
      </button>

      <!-- Ribosome -->
      <button
        slot="hotspot-ribosome"
        class="hotspot"
        data-position="4.136 0.694 -7.623"
        data-normal="-0.507 -0.181 0.842"
        data-visibility-attribute="visible">
        <div class="hotspot-label">
          Ribosome
          <span class="hotspot-description">
            Site of protein synthesis.
          </span>
        </div>
      </button>

      <!-- Primary Granules -->
      <button
        slot="hotspot-granules"
        class="hotspot"
        data-position="-3.712 -1.263 7.749"
        data-normal="0.521 0.181 -0.834"
        data-visibility-attribute="visible">
        <div class="hotspot-label">
          Primary Granules
          <span class="hotspot-description">
            Contain enzymes used in cellular defense and digestion.
          </span>
        </div>
      </button>

      <!-- AR prompt + tracking warning -->
      <div id="ar-prompt">
        <img src="hand.png" alt="Move phone to find surface" />
      </div>

      <button id="ar-failure">AR is not tracking!</button>
    </model-viewer>

    <!-- Hotspot tuning controls -->
    <div id="hotspot-controls">
      <h2>Hotspot Tuner</h2>
      <p>Drag sliders; hotspots move in real time. Copy coords when satisfied.</p>

      <!-- Each panel binds to a hotspot id via data-hotspot -->
      <div class="hotspot-panel" data-hotspot="nucleus">
        <div class="hotspot-panel-title">
          <span class="name">Nucleus</span>
          <span class="coords" id="nucleus-coords"></span>
        </div>
        <div class="axis-row">
          <label>X</label>
          <input type="range" data-axis="x" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="nucleus-x"></span>
        </div>
        <div class="axis-row">
          <label>Y</label>
          <input type="range" data-axis="y" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="nucleus-y"></span>
        </div>
        <div class="axis-row">
          <label>Z</label>
          <input type="range" data-axis="z" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="nucleus-z"></span>
        </div>
      </div>

      <div class="hotspot-panel" data-hotspot="golgi">
        <div class="hotspot-panel-title">
          <span class="name">Golgi Complex</span>
          <span class="coords" id="golgi-coords"></span>
        </div>
        <div class="axis-row">
          <label>X</label>
          <input type="range" data-axis="x" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="golgi-x"></span>
        </div>
        <div class="axis-row">
          <label>Y</label>
          <input type="range" data-axis="y" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="golgi-y"></span>
        </div>
        <div class="axis-row">
          <label>Z</label>
          <input type="range" data-axis="z" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="golgi-z"></span>
        </div>
      </div>

      <div class="hotspot-panel" data-hotspot="mito">
        <div class="hotspot-panel-title">
          <span class="name">Mitochondrion</span>
          <span class="coords" id="mito-coords"></span>
        </div>
        <div class="axis-row">
          <label>X</label>
          <input type="range" data-axis="x" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="mito-x"></span>
        </div>
        <div class="axis-row">
          <label>Y</label>
          <input type="range" data-axis="y" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="mito-y"></span>
        </div>
        <div class="axis-row">
          <label>Z</label>
          <input type="range" data-axis="z" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="mito-z"></span>
        </div>
      </div>

      <div class="hotspot-panel" data-hotspot="ribosome">
        <div class="hotspot-panel-title">
          <span class="name">Ribosome</span>
          <span class="coords" id="ribosome-coords"></span>
        </div>
        <div class="axis-row">
          <label>X</label>
          <input type="range" data-axis="x" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="ribosome-x"></span>
        </div>
        <div class="axis-row">
          <label>Y</label>
          <input type="range" data-axis="y" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="ribosome-y"></span>
        </div>
        <div class="axis-row">
          <label>Z</label>
          <input type="range" data-axis="z" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="ribosome-z"></span>
        </div>
      </div>

      <div class="hotspot-panel" data-hotspot="granules">
        <div class="hotspot-panel-title">
          <span class="name">Primary Granules</span>
          <span class="coords" id="granules-coords"></span>
        </div>
        <div class="axis-row">
          <label>X</label>
          <input type="range" data-axis="x" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="granules-x"></span>
        </div>
        <div class="axis-row">
          <label>Y</label>
          <input type="range" data-axis="y" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="granules-y"></span>
        </div>
        <div class="axis-row">
          <label>Z</label>
          <input type="range" data-axis="z" min="-15" max="15" step="0.01" />
          <span class="axis-value" id="granules-z"></span>
        </div>
      </div>
    </div>

    <script>
      const modelViewer = document.querySelector("#cell-viewer");

      // Initial positions from your raycasts
      const hotspotConfigs = {
        nucleus: { x: -8.332, y: 1.103, z: -1.368 },
        golgi: { x: 5.767, y: 5.383, z: 3.847 },
        mito: { x: 7.916, y: 3.887, z: 0.024 },
        ribosome: { x: 4.136, y: 0.694, z: -7.623 },
        granules: { x: -3.712, y: -1.263, z: 7.749 },
      };

      function updateHotspotPosition(id) {
        const cfg = hotspotConfigs[id];
        if (!cfg) return;

        const hotspotEl = modelViewer.querySelector(
          `[slot="hotspot-${id}"]`
        );
        if (!hotspotEl) return;

        const posStr = `${cfg.x.toFixed(3)} ${cfg.y.toFixed(3)} ${cfg.z.toFixed(
          3
        )}`;
        hotspotEl.setAttribute("data-position", posStr);

        const coordsLabel = document.getElementById(`${id}-coords`);
        if (coordsLabel) coordsLabel.textContent = posStr;

        const axes = ["x", "y", "z"];
        axes.forEach((axis) => {
          const valLabel = document.getElementById(`${id}-${axis}`);
          if (valLabel) valLabel.textContent = cfg[axis].toFixed(2);
        });
      }

      function initSliders() {
        const panels = document.querySelectorAll(".hotspot-panel");
        panels.forEach((panel) => {
          const id = panel.dataset.hotspot;
          const cfg = hotspotConfigs[id];
          if (!cfg) return;

          const sliders = panel.querySelectorAll('input[type="range"]');
          sliders.forEach((slider) => {
            const axis = slider.dataset.axis;
            slider.value = cfg[axis];
            slider.addEventListener("input", (e) => {
              const v = parseFloat(e.target.value);
              hotspotConfigs[id][axis] = v;
              updateHotspotPosition(id);
            });
          });

          // Initial label update
          updateHotspotPosition(id);
        });
      }

      // Optional: click helper to log raycast hits to DevTools console
      modelViewer.addEventListener("click", async (event) => {
        const rect = modelViewer.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        const hit = await modelViewer.positionAndNormalFromPoint(x, y);
        if (hit) {
          const { position, normal } = hit;
          console.log(
            "Hit position:",
            position.x.toFixed(3),
            position.y.toFixed(3),
            position.z.toFixed(3)
          );
          console.log(
            "Hit normal:",
            normal.x.toFixed(3),
            normal.y.toFixed(3),
            normal.z.toFixed(3)
          );
        } else {
          console.log("No hit at that point");
        }
      });

      window.addEventListener("DOMContentLoaded", () => {
        initSliders();
      });
    </script>
  </body>
</html>

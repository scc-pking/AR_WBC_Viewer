<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AR Model Viewer with Hotspot Helper</title>

    <!-- model-viewer web component -->
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js">
    </script>

    <style>
      :not(:defined) > * {
        display: none;
      }

      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }

      model-viewer {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100dvh;
        background-color: #111;
        overflow: hidden;
      }

      #ar-button {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: calc(env(safe-area-inset-bottom) + 20px);
        z-index: 9999;

        background-color: #fff;
        padding: 0 26px;
        min-width: 220px;
        height: 48px;
        line-height: 48px;

        font-size: 16px;
        font-weight: 500;
        color: #4285f4;

        border-radius: 24px;
        border: 1px solid #dadce0;
        white-space: nowrap;
      }

      #ar-button:active {
        background-color: #e8eaed;
      }

      #ar-button:focus {
        outline: none;
      }

      #ar-button:focus-visible {
        outline: 1px solid #4285f4;
      }

      .hotspot {
        border: none;
        padding: 0;
        background: none;
        cursor: pointer;
        transform: translate(-50%, -50%);
      }

      .hotspot-label {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.75);
        color: #fff;
        font-size: 12px;
        line-height: 1.3;
      }

      .hotspot-label::before {
        content: "";
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #4caf50;
      }

      .hotspot-description {
        display: none;
        margin-left: 4px;
        font-size: 11px;
        opacity: 0.9;
      }

      .hotspot:hover .hotspot-description {
        display: inline;
      }

      @keyframes circle {
        from {
          transform: translateX(-50%) rotate(0deg) translateX(50px) rotate(0deg);
        }
        to {
          transform: translateX(-50%) rotate(360deg) translateX(50px) rotate(-360deg);
        }
      }

      @keyframes elongate {
        from {
          transform: translateX(100px);
        }
        to {
          transform: translateX(-100px);
        }
      }

      model-viewer > #ar-prompt {
        position: absolute;
        left: 50%;
        bottom: 175px;
        animation: elongate 2s infinite ease-in-out alternate;
        display: none;
      }

      model-viewer[ar-status="session-started"] > #ar-prompt {
        display: block;
      }

      model-viewer > #ar-prompt > img {
        animation: circle 4s linear infinite;
      }

      model-viewer > #ar-failure {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        bottom: 175px;
        display: none;
      }

      model-viewer[ar-tracking="not-tracking"] > #ar-failure {
        display: block;
      }

      /* Hotspot helper panel */
      #hotspot-helper {
        position: fixed;
        top: 12px;
        right: 12px;
        z-index: 10000;
        background: rgba(15, 15, 15, 0.9);
        color: #f5f5f5;
        padding: 10px 12px;
        border-radius: 10px;
        backdrop-filter: blur(12px);
        max-width: 260px;
        font-size: 12px;
      }

      #hotspot-helper label {
        display: block;
        margin-top: 8px;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        opacity: 0.8;
      }

      #hotspot-helper select,
      #hotspot-helper input[type="range"] {
        width: 100%;
        margin-top: 4px;
      }

      #hotspot-helper .value {
        font-variant-numeric: tabular-nums;
        font-size: 11px;
        opacity: 0.9;
      }
    </style>
  </head>

  <body>
    <model-viewer id="cell-viewer"
                  src="model.glb"
                  ios-src="model.usdz"
                  shadow-intensity="1"
                  ar
                  camera-controls
                  touch-action="pan-y"
                  alt="A 3D cell model with hotspots">

      <!-- AR button -->
      <button slot="ar-button" id="ar-button">
        View in your space
      </button>

      <!-- Example hotspots using your coords -->
      <button id="hotspot-nucleus"
              slot="hotspot-nucleus"
              class="hotspot"
              data-position="-8.332 1.103 -1.368"
              data-normal="0.973 -0.164 0.164"
              data-label="Nucleus">
        <div class="hotspot-label">
          Nucleus
          <span class="hotspot-description">
            Contains genetic material and controls cell activities.
          </span>
        </div>
      </button>

      <button id="hotspot-golgi"
              slot="hotspot-golgi"
              class="hotspot"
              data-position="5.767 5.383 3.847"
              data-normal="-0.679 -0.519 -0.519"
              data-label="Golgi Complex">
        <div class="hotspot-label">
          Golgi Complex
          <span class="hotspot-description">
            Packages and modifies proteins for transport.
          </span>
        </div>
      </button>

      <button id="hotspot-mito"
              slot="hotspot-mito"
              class="hotspot"
              data-position="7.916 3.887 0.024"
              data-normal="-0.842 -0.507 -0.181"
              data-label="Mitochondrion">
        <div class="hotspot-label">
          Mitochondrion
          <span class="hotspot-description">
            Produces ATP, the cell’s usable energy.
          </span>
        </div>
      </button>

      <!-- AR helper prompt -->
      <div id="ar-prompt">
        <img src="hand.png" alt="Move phone to find surface" />
      </div>

      <button id="ar-failure">
        AR is not tracking!
      </button>
    </model-viewer>

    <!-- Hotspot tuning helper UI -->
    <div id="hotspot-helper">
      <div style="font-weight:600;">Hotspot Tuning</div>

      <label for="hotspot-select">Hotspot</label>
      <select id="hotspot-select"></select>

      <label for="depth-range">Depth along normal</label>
      <input id="depth-range" type="range" min="-5" max="5" step="0.05" value="0" />
      <div class="value">Offset: <span id="depth-value">0.00</span></div>

      <label>Current position</label>
      <div class="value" id="position-readout">x: 0, y: 0, z: 0</div>
    </div>

    <script>
      const modelViewer = document.getElementById("cell-viewer");

      // Collect hotspots and store base position + normal vectors
      const hotspots = Array.from(
        modelViewer.querySelectorAll(".hotspot")
      ).map((el) => {
        const id = el.id;
        const label = el.dataset.label || id;

        const basePos = el
          .getAttribute("data-position")
          .split(" ")
          .map(parseFloat);
        const normal = el
          .getAttribute("data-normal")
          .split(" ")
          .map(parseFloat);

        return {
          id,
          label,
          element: el,
          basePos, // original hit on the membrane
          normal,  // direction we’ll move along
          offset: 0,
        };
      });

      const hotspotSelect = document.getElementById("hotspot-select");
      const depthRange = document.getElementById("depth-range");
      const depthValue = document.getElementById("depth-value");
      const positionReadout = document.getElementById("position-readout");

      // Populate dropdown
      hotspots.forEach((h, index) => {
        const opt = document.createElement("option");
        opt.value = h.id;
        opt.textContent = h.label;
        if (index === 0) opt.selected = true;
        hotspotSelect.appendChild(opt);
      });

      function getSelectedHotspot() {
        const id = hotspotSelect.value;
        return hotspots.find((h) => h.id === id);
      }

      function updateHotspotPosition(hotspot, offset) {
        hotspot.offset = offset;

        const [bx, by, bz] = hotspot.basePos;
        const [nx, ny, nz] = hotspot.normal;

        const x = bx + nx * offset;
        const y = by + ny * offset;
        const z = bz + nz * offset;

        const posString = `${x.toFixed(3)} ${y.toFixed(3)} ${z.toFixed(3)}`;

        hotspot.element.setAttribute("data-position", posString);

        // Update UI readout
        positionReadout.textContent = `x: ${x.toFixed(3)}, y: ${y.toFixed(
          3
        )}, z: ${z.toFixed(3)}`;

        // Log to console so you can copy final coords
        console.log(
          `[${hotspot.label}] offset=${offset.toFixed(
            2
          )} → data-position="${posString}"`
        );
      }

      // Initialize UI with first hotspot
      const initialHotspot = getSelectedHotspot();
      if (initialHotspot) {
        updateHotspotPosition(initialHotspot, 0);
      }

      hotspotSelect.addEventListener("change", () => {
        // Reset slider when switching hotspots, or keep it – your choice
        depthRange.value = getSelectedHotspot().offset.toString();
        depthValue.textContent = getSelectedHotspot().offset.toFixed(2);
        updateHotspotPosition(getSelectedHotspot(), getSelectedHotspot().offset);
      });

      depthRange.addEventListener("input", (e) => {
        const offset = parseFloat(e.target.value);
        depthValue.textContent = offset.toFixed(2);
        const hotspot = getSelectedHotspot();
        updateHotspotPosition(hotspot, offset);
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AR Model Viewer with Hotspots</title>

    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"
    ></script>

    <style>
      :not(:defined) > * { display: none; }

      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden; /* kill page scroll */
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #111;
      }

      model-viewer {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100dvh;
        background-color: #111;
        overflow: hidden;
        display: none; /* hidden until a model is selected */
      }

      /* ===== Landing ===== */
      #landing {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        padding: 18px;
        background: radial-gradient(1200px 800px at 50% 20%, rgba(66,133,244,0.20), rgba(0,0,0,0.0) 60%),
                    radial-gradient(900px 600px at 20% 80%, rgba(76,175,80,0.16), rgba(0,0,0,0.0) 55%),
                    #0e0f12;
        color: #fff;
        z-index: 10010;
      }

      #landing .card {
        width: min(720px, 100%);
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(0,0,0,0.55);
        backdrop-filter: blur(10px);
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.35);
      }

      #landing h1 {
        margin: 0 0 8px;
        font-size: 20px;
        font-weight: 650;
        letter-spacing: 0.2px;
      }

      #landing p {
        margin: 0 0 14px;
        opacity: 0.85;
        line-height: 1.45;
        font-size: 14px;
      }

      #landing .grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }

      @media (max-width: 540px) {
        #landing .grid { grid-template-columns: 1fr; }
      }

      .pick {
        cursor: pointer;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.04);
        border-radius: 14px;
        padding: 14px 14px;
        color: #fff;
        text-align: left;
        transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
        font-weight: 650;
      }

      .pick:hover {
        transform: translateY(-1px);
        border-color: rgba(66,133,244,0.55);
        background: rgba(66,133,244,0.10);
      }

      /* ===== Topbar controls (model select + tuner) ===== */
      #topbar {
        position: fixed;
        top: calc(env(safe-area-inset-top) + 10px);
        left: 10px;
        right: 10px;
        z-index: 10011;
        display: none; /* show after selection */
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        pointer-events: none;
      }

      #model-menu {
        pointer-events: auto;
        display: inline-flex;
        gap: 8px;
        align-items: center;
        padding: 8px 10px;
        border-radius: 14px;
        background: rgba(0,0,0,0.65);
        border: 1px solid rgba(255,255,255,0.12);
        backdrop-filter: blur(6px);
      }

      .model-btn {
        pointer-events: auto;
        cursor: pointer;
        color: #fff;
        font-size: 13px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.12);
        background: transparent;
        opacity: 0.9;
      }

      .model-btn.active {
        border-color: rgba(66,133,244,0.9);
        box-shadow: 0 0 0 2px rgba(66,133,244,0.15) inset;
        opacity: 1;
      }

      #tuner-toggle {
        pointer-events: auto;
        cursor: pointer;
        color: #fff;
        background: rgba(0,0,0,0.65);
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 999px;
        padding: 8px 12px;
        font-size: 13px;
      }

      /* ===== Error banner ===== */
      #errorbox {
        position: fixed;
        left: 10px;
        right: 10px;
        bottom: calc(env(safe-area-inset-bottom) + 10px);
        z-index: 10012;
        display: none;
        padding: 10px 12px;
        border-radius: 14px;
        background: rgba(120, 20, 20, 0.78);
        border: 1px solid rgba(255,255,255,0.18);
        color: #fff;
        font-size: 13px;
        line-height: 1.35;
        white-space: pre-wrap;
      }

      #ar-button {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: calc(env(safe-area-inset-bottom) + 20px);
        z-index: 9999;

        background-color: #fff;
        padding: 0 26px;
        min-width: 220px;
        height: 48px;
        line-height: 48px;

        font-size: 16px;
        font-weight: 500;
        color: #4285f4;

        border-radius: 24px;
        border: 1px solid #dadce0;
        white-space: nowrap;
      }
      #ar-button:active { background-color: #e8eaed; }
      #ar-button:focus { outline: none; }
      #ar-button:focus-visible { outline: 1px solid #4285f4; }

      @keyframes circle {
        from { transform: translateX(-50%) rotate(0deg) translateX(50px) rotate(0deg); }
        to { transform: translateX(-50%) rotate(360deg) translateX(50px) rotate(-360deg); }
      }
      @keyframes elongate {
        from { transform: translateX(100px); }
        to { transform: translateX(-100px); }
      }

      model-viewer > #ar-prompt {
        position: absolute;
        left: 50%;
        bottom: 175px;
        animation: elongate 2s infinite ease-in-out alternate;
        display: none;
      }
      model-viewer[ar-status="session-started"] > #ar-prompt { display: block; }
      model-viewer > #ar-prompt > img { animation: circle 4s linear infinite; }

      model-viewer > #ar-failure {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        bottom: 175px;
        display: none;
      }
      model-viewer[ar-tracking="not-tracking"] > #ar-failure { display: block; }

      /* ========================
         HOTSPOTS
         ======================== */
      .hotspot {
        border: none;
        padding: 0;
        background: none;
        cursor: pointer;
        position: relative;
        --hotspot-scale: 1;
        transform: translate(-50%, -50%) scale(var(--hotspot-scale));
      }

      .hotspot-anchor-dot {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #4caf50;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 8px rgba(76, 175, 80, 0.8);
      }

      .hotspot-line {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 2px;
        height: 40px;
        background: #4caf50;
        transform: translate(-50%, -100%);
        opacity: 0.8;
      }

      .hotspot-label {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, calc(-100% - 48px));
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.85);
        color: #fff;
        font-size: 16px;
        line-height: 1.3;
        white-space: nowrap;
      }

      .hotspot-label::before { content: none; }

      .hotspot-description {
        display: none;
        margin-left: 4px;
        font-size: 13px;
        opacity: 0.9;
      }
      .hotspot:hover .hotspot-description { display: inline; }

      /* AR MODE: smaller hotspots + hide descriptions */
      model-viewer[ar-status="session-started"] .hotspot { --hotspot-scale: 0.55; }
      model-viewer[ar-status="session-started"] .hotspot-label { padding: 6px 9px; font-size: 12px; }
      model-viewer[ar-status="session-started"] .hotspot-anchor-dot { width: 8px; height: 8px; }
      model-viewer[ar-status="session-started"] .hotspot-line { height: 30px; }
      model-viewer[ar-status="session-started"] .hotspot-description { display: none !important; }

      /* ========================
         HOTSPOT TUNER PANEL
         ======================== */
      #hotspot-controls {
        position: fixed;
        right: 0;
        bottom: 0;
        width: 320px;
        max-height: 60vh;
        overflow-y: auto;
        padding: 12px;
        background: rgba(0, 0, 0, 0.9);
        color: #fff;
        font-size: 12px;
        z-index: 10000;
        display: none;
      }
      #hotspot-controls.is-open { display: block; }

      #hotspot-controls h3 { margin: 0 0 8px; font-size: 14px; }
      #hotspot-controls label { display: block; margin: 2px 0; }
      #hotspot-controls input[type="range"] { width: 100%; }
      .hotspot-section { margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 6px; }
      .hotspot-readout { margin-top: 2px; font-family: monospace; font-size: 11px; }

      /* ========================
         AR ROTATION SLIDER (USER-FACING)
         ======================== */
      #ar-rotate-bar {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: calc(env(safe-area-inset-bottom) + 14px);
        z-index: 10001;

        width: min(560px, calc(100vw - 24px));
        padding: 10px 12px;
        border-radius: 16px;

        background: rgba(0, 0, 0, 0.65);
        color: #fff;

        display: none; /* only in AR */
        gap: 10px;
        align-items: center;
      }

      model-viewer[ar-status="session-started"] ~ #ar-rotate-bar {
        display: flex;
      }

      #ar-rotate-bar .label {
        font-size: 12px;
        opacity: 0.95;
        white-space: nowrap;
      }

      #ar-rotate {
        width: 100%;
      }
    </style>
  </head>

  <body>
    <!-- Landing (no models loaded until user chooses) -->
    <div id="landing">
      <div class="card">
        <h1>Select a cell type</h1>
        <p>Choose a model to open the viewer.</p>
        <div class="grid" id="landing-grid"></div>
      </div>
    </div>

    <!-- Topbar (shown after selection) -->
    <div id="topbar">
      <div id="model-menu"></div>
      <button id="tuner-toggle" type="button">Tuner</button>
    </div>

    <model-viewer
      id="cellViewer"
      shadow-intensity="1"
      ar
      ar-modes="webxr scene-viewer quick-look"
      camera-controls
      disable-pan
      touch-action="pan-y"
      interaction-prompt="none"
      camera-target="auto auto auto"
      camera-orbit="0deg 70deg 105%"
      min-camera-orbit="auto auto 80%"
      max-camera-orbit="auto auto 140%"
    >
      <button slot="ar-button" id="ar-button">View in your space</button>

      <!-- Nucleus -->
      <button
        id="hotspot-nucleus"
        slot="hotspot-nucleus"
        class="hotspot"
        data-position="-1.300 2.000 -2.200"
        data-normal="0.973 -0.164 0.164"
      >
        <div class="hotspot-anchor-dot"></div>
        <div class="hotspot-line"></div>
        <div class="hotspot-label">
          Nucleus
          <span class="hotspot-description">Contains genetic material and controls cell activities.</span>
        </div>
      </button>

      <!-- Golgi Complex -->
      <button
        id="hotspot-golgi"
        slot="hotspot-golgi"
        class="hotspot"
        data-position="0.900 0.600 -0.100"
        data-normal="1.000 0.600 -0.700"
      >
        <div class="hotspot-anchor-dot"></div>
        <div class="hotspot-line"></div>
        <div class="hotspot-label">
          Golgi Complex
          <span class="hotspot-description">Packages and modifies proteins and lipids.</span>
        </div>
      </button>

      <!-- Mitochondrion -->
      <button
        id="hotspot-mito"
        slot="hotspot-mito"
        class="hotspot"
        data-position="3.600 0.200 -3.600"
        data-normal="-0.842 -0.507 -0.181"
      >
        <div class="hotspot-anchor-dot"></div>
        <div class="hotspot-line"></div>
        <div class="hotspot-label">
          Mitochondrion
          <span class="hotspot-description">Produces energy (ATP) for the cell.</span>
        </div>
      </button>

      <!-- Ribosome -->
      <button
        id="hotspot-ribosome"
        slot="hotspot-ribosome"
        class="hotspot"
        data-position="2.300 -0.200 -4.300"
        data-normal="-0.507 -0.181 0.842"
      >
        <div class="hotspot-anchor-dot"></div>
        <div class="hotspot-line"></div>
        <div class="hotspot-label">
          Ribosome
          <span class="hotspot-description">Site of protein synthesis.</span>
        </div>
      </button>

      <!-- Primary Granules -->
      <button
        id="hotspot-granules"
        slot="hotspot-granules"
        class="hotspot"
        data-position="-2.900 -1.600 5.800"
        data-normal="0.521 0.181 -0.834"
      >
        <div class="hotspot-anchor-dot"></div>
        <div class="hotspot-line"></div>
        <div class="hotspot-label">
          Primary Granules
          <span class="hotspot-description">Granule structures with stored enzymes or molecules.</span>
        </div>
      </button>

      <div id="ar-prompt">
        <img src="hand.png" alt="Move phone to find surface" />
      </div>

      <button id="ar-failure">AR is not tracking!</button>
    </model-viewer>

    <!-- User-facing AR rotation slider -->
    <div id="ar-rotate-bar">
      <div class="label">Rotate</div>
      <input id="ar-rotate" type="range" min="-180" max="180" step="1" value="0" />
    </div>

    <!-- Hotspot tuner (toggle with on-screen button) -->
    <div id="hotspot-controls">
      <h3>Hotspot Position Tuner</h3>

      <div class="hotspot-section" data-hotspot="hotspot-nucleus">
        <strong>Nucleus</strong>
        <label>X <input type="range" class="hotspot-x" min="-15" max="15" step="0.1" /></label>
        <label>Y <input type="range" class="hotspot-y" min="-15" max="15" step="0.1" /></label>
        <label>Z <input type="range" class="hotspot-z" min="-15" max="15" step="0.1" /></label>
        <div class="hotspot-readout"></div>
      </div>

      <div class="hotspot-section" data-hotspot="hotspot-golgi">
        <strong>Golgi Complex</strong>
        <label>X <input type="range" class="hotspot-x" min="-15" max="15" step="0.1" /></label>
        <label>Y <input type="range" class="hotspot-y" min="-15" max="15" step="0.1" /></label>
        <label>Z <input type="range" class="hotspot-z" min="-15" max="15" step="0.1" /></label>
        <div class="hotspot-readout"></div>
      </div>

      <div class="hotspot-section" data-hotspot="hotspot-mito">
        <strong>Mitochondrion</strong>
        <label>X <input type="range" class="hotspot-x" min="-15" max="15" step="0.1" /></label>
        <label>Y <input type="range" class="hotspot-y" min="-15" max="15" step="0.1" /></label>
        <label>Z <input type="range" class="hotspot-z" min="-15" max="15" step="0.1" /></label>
        <div class="hotspot-readout"></div>
      </div>

      <div class="hotspot-section" data-hotspot="hotspot-ribosome">
        <strong>Ribosome</strong>
        <label>X <input type="range" class="hotspot-x" min="-15" max="15" step="0.1" /></label>
        <label>Y <input type="range" class="hotspot-y" min="-15" max="15" step="0.1" /></label>
        <label>Z <input type="range" class="hotspot-z" min="-15" max="15" step="0.1" /></label>
        <div class="hotspot-readout"></div>
      </div>

      <div class="hotspot-section" data-hotspot="hotspot-granules">
        <strong>Primary Granules</strong>
        <label>X <input type="range" class="hotspot-x" min="-15" max="15" step="0.1" /></label>
        <label>Y <input type="range" class="hotspot-y" min="-15" max="15" step="0.1" /></label>
        <label>Z <input type="range" class="hotspot-z" min="-15" max="15" step="0.1" /></label>
        <div class="hotspot-readout"></div>
      </div>
    </div>

    <div id="errorbox"></div>

    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const viewer = document.getElementById("cellViewer");
        const tunerPanel = document.getElementById("hotspot-controls");
        const tunerToggle = document.getElementById("tuner-toggle");
        const arRotate = document.getElementById("ar-rotate");
        const landing = document.getElementById("landing");
        const landingGrid = document.getElementById("landing-grid");
        const topbar = document.getElementById("topbar");
        const modelMenu = document.getElementById("model-menu");
        const errorbox = document.getElementById("errorbox");

        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

        const MODELS = [
          { key: "neutrophil", label: "Neutrophil", glb: "./neutrophil.glb", usdz: "./neutrophil.usdz" },
          { key: "basophil",   label: "Basophil",   glb: "./basophil.glb",   usdz: "./basophil.usdz" },
          { key: "eosinophil", label: "Eosinophil", glb: "./eosinophil.glb", usdz: "./eosinophil.usdz" },
        ];

        const HOTSPOT_PRESETS = {
            neutrophil: {
                "hotspot-nucleus": [-1.300, 2.000, -2.200],
                "hotspot-golgi": [0.900, 0.600, -0.100],
                "hotspot-mito": [3.600, 0.200, -3.600],
                "hotspot-ribosome": [2.300, -0.200, -4.300],
                "hotspot-granules": [-2.900, -1.600, 5.800],
            },

            basophil: {
                "hotspot-nucleus": [-1.300, 2.000, -2.200],
                "hotspot-golgi": [0.900, 0.600, -0.100],
                "hotspot-mito": [3.600, 0.200, -3.600],
                "hotspot-ribosome": [2.300, -0.200, -4.300],
                "hotspot-granules": [-2.900, -1.600, 5.800],
            },

            eosinophil: {
                "hotspot-nucleus": [-1.300, 2.000, -2.200],
                "hotspot-golgi": [0.900, 0.600, -0.100],
                "hotspot-mito": [3.600, 0.200, -3.600],
                "hotspot-ribosome": [4.700, -2.400, -0.600],
                "hotspot-granules": [-2.900, -1.600, 5.800],
              },
          };

        let activeKey = null;

        // ---------- helpers ----------
        const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

        function setError(msg) {
          if (!msg) {
            errorbox.style.display = "none";
            errorbox.textContent = "";
            return;
          }
          errorbox.style.display = "block";
          errorbox.textContent = msg;
        }

        function parseDataPosition(el) {
          const raw = (el.getAttribute("data-position") || "").trim();
          const parts = raw.split(/\s+/).map(Number);
          if (parts.length === 3 && parts.every((n) => Number.isFinite(n))) return parts;
          return [0, 0, 0];
        }

        function setHotspotPosition(hotspotId, x, y, z) {
          const el = document.getElementById(hotspotId);
          if (!el) return;

          const slotName = el.getAttribute("slot"); // e.g. "hotspot-nucleus"
          const posString = `${x.toFixed(3)} ${y.toFixed(3)} ${z.toFixed(3)}`;

          el.setAttribute("data-position", posString);

          if (viewer && typeof viewer.updateHotspot === "function" && slotName) {
            viewer.updateHotspot({ name: slotName, position: posString });
          }
        }

          function applyHotspotPresetFor(key) {
              const preset = HOTSPOT_PRESETS[key];
              if (!preset) return;

              Object.entries(preset).forEach(([hotspotId, xyz]) => {
                  const [x, y, z] = xyz;
                  setHotspotPosition(hotspotId, x, y, z);
              });
          }

        // ---------- tuner ----------
        function initSection(sectionEl) {
          const hotspotId = sectionEl.getAttribute("data-hotspot");
          const hotspotEl = document.getElementById(hotspotId);
          if (!hotspotEl) return;

          const [x0, y0, z0] = parseDataPosition(hotspotEl);

          const xSlider = sectionEl.querySelector(".hotspot-x");
          const ySlider = sectionEl.querySelector(".hotspot-y");
          const zSlider = sectionEl.querySelector(".hotspot-z");
          const readout = sectionEl.querySelector(".hotspot-readout");

          xSlider.value = x0;
          ySlider.value = y0;
          zSlider.value = z0;

          const update = () => {
            const x = parseFloat(xSlider.value);
            const y = parseFloat(ySlider.value);
            const z = parseFloat(zSlider.value);

            setHotspotPosition(hotspotId, x, y, z);
            readout.textContent = `data-position="${x.toFixed(3)} ${y.toFixed(3)} ${z.toFixed(3)}"`;
          };

          xSlider.addEventListener("input", update);
          ySlider.addEventListener("input", update);
          zSlider.addEventListener("input", update);

          update();
        }

        function initAllSections() {
          document
            .querySelectorAll("#hotspot-controls .hotspot-section")
            .forEach(initSection);
        }

        // Toggle tuner with on-screen button
        tunerToggle.addEventListener("click", () => {
          tunerPanel.classList.toggle("is-open");
        });

        // ---------- hotspot scale with zoom (3D only) ----------
        function updateHotspotScale() {
          const arStatus = viewer.getAttribute("ar-status");
          if (arStatus && arStatus !== "not-presenting" && arStatus !== "failed") return;

          const orbit = viewer.getCameraOrbit();
          const radius = orbit.radius;

          const minRadius = 4;
          const maxRadius = 18;

          const t = clamp((radius - minRadius) / (maxRadius - minRadius), 0, 1);

          const minScale = 1.0;
          const maxScale = 2.2;

          const scale = maxScale - (maxScale - minScale) * t;

          viewer.querySelectorAll(".hotspot").forEach((el) => {
            el.style.setProperty("--hotspot-scale", scale);
          });
        }

        // ---------- AR rotation slider ----------
        function applyModelYaw(deg) {
          viewer.setAttribute("orientation", `0deg ${deg}deg 0deg`);
        }

        arRotate.addEventListener("input", () => {
          const yaw = parseFloat(arRotate.value);
          applyModelYaw(yaw);
        });

        viewer.addEventListener("ar-status", () => {
          const status = viewer.getAttribute("ar-status");
          if (status === "session-started" || status === "not-presenting") {
            arRotate.value = "0";
            applyModelYaw(0);
          }
        });

        // ---------- model switching ----------
        function renderModelMenu() {
          modelMenu.innerHTML = MODELS.map(m => {
            const cls = m.key === activeKey ? "model-btn active" : "model-btn";
            return `<button class="${cls}" type="button" data-model="${m.key}">${m.label}</button>`;
          }).join("");

          modelMenu.querySelectorAll("button[data-model]").forEach(btn => {
            btn.addEventListener("click", () => {
              const key = btn.getAttribute("data-model");
              selectModel(key);
            });
          });
        }

        function selectModel(key) {
          const m = MODELS.find(x => x.key === key);
          if (!m) return;

          setError(null);
          activeKey = key;

          // Show viewer UI
          landing.style.display = "none";
          viewer.style.display = "block";
          topbar.style.display = "flex";
          renderModelMenu();

          // Swap sources
          viewer.removeAttribute("src");
          viewer.removeAttribute("ios-src");

          // Force a fresh load next frame
          requestAnimationFrame(() => {
            viewer.setAttribute("src", m.glb);
            if (isIOS) viewer.setAttribute("ios-src", m.usdz);
          });

          // Re-init after load (updateHotspot safest after load)
          viewer.addEventListener("load", () => {
            applyHotspotPresetFor(activeKey);
            initAllSections();
            updateHotspotScale();
          }, { once: true });

          viewer.addEventListener("error", (ev) => {
            const detail = ev?.detail ? JSON.stringify(ev.detail) : "";
            setError(`Model failed to load.\nSelected: ${m.label}\nSRC: ${m.glb}\n${detail}`);
          }, { once: true });
        }

        // ---------- landing ----------
        function buildLanding() {
          landingGrid.innerHTML = MODELS.map(m => `
            <button class="pick" type="button" data-model="${m.key}">${m.label}</button>
          `).join("");

          landingGrid.querySelectorAll("button[data-model]").forEach(btn => {
            btn.addEventListener("click", () => {
              selectModel(btn.getAttribute("data-model"));
            });
          });
        }

        // Initial state: landing only, no model loaded
        buildLanding();
        topbar.style.display = "none";
        viewer.style.display = "none";
        tunerPanel.classList.remove("is-open");

        // Keep scale updates
        viewer.addEventListener("camera-change", updateHotspotScale);
      });
    </script>
  </body>
</html>
